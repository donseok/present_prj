# DocuGen 프로세스 플로우차트

본 문서는 DocuGen 시스템의 주요 프로세스를 Mermaid 다이어그램으로 시각화합니다.

---

## 1. 전체 시스템 흐름

```mermaid
flowchart TB
    subgraph Client["클라이언트 (React + TypeScript + Tailwind)"]
        A[로그인] --> B[홈 화면]
        B --> C{작업 선택}
        C -->|프로젝트 관리| D[프로젝트 목록]
        C -->|템플릿 관리| E[템플릿 목록]
        C -->|문서 생성| F[문서 생성 화면]
        C -->|폴더 분석| G[프로젝트 분석]
        D --> D1[프로젝트 등록/수정]
        D --> D2[프로젝트 분석으로 등록]
        E --> E1[템플릿 업로드]
        F --> F1[문서 다운로드]
        F --> F2[폴더에 저장]
        G --> G1[폴더 선택]
        G1 --> G2[자동 분석]
        G2 --> G3[결과 검토/수정]
        G3 --> D[프로젝트로 저장]
    end

    subgraph Server["서버 (Express + TypeScript)"]
        H[REST API]
        I[(DataStore - JSON)]
        J[Generators]
        K[ProjectAnalyzer]
    end

    D1 <-->|CRUD| H
    E1 <-->|Upload| H
    F -->|Generate| H
    G2 -->|Analyze| H
    H <--> I
    H --> J
    H --> K
    J --> F1
    J --> F2
```

---

## 2. 프로젝트 폴더 분석 프로세스 (신규)

```mermaid
sequenceDiagram
    autonumber
    participant U as 사용자
    participant C as Client (React)
    participant S as Server (Express)
    participant PA as ProjectAnalyzer
    participant FS as 파일 시스템

    U->>C: "프로젝트 분석" 메뉴 클릭

    C->>S: GET /api/analyze/drives
    S->>FS: 드라이브 목록 조회
    FS-->>S: 드라이브 배열 [C:, D:, ...]
    S-->>C: { drives: [...] }

    C->>S: GET /api/analyze/browse
    S->>FS: os.homedir() 기본 경로
    FS-->>S: 디렉토리 목록
    S-->>C: { currentPath, parentPath, items }

    U->>C: 폴더 탐색 및 선택

    loop 폴더 탐색
        C->>S: GET /api/analyze/browse?path=...
        S->>FS: readdir(path)
        FS-->>S: 파일/폴더 목록
        S-->>C: { currentPath, parentPath, items }
    end

    U->>C: "분석 시작" 버튼 클릭
    C->>S: POST /api/analyze/folder<br/>{folderPath}

    S->>PA: analyzeProjectFolder(path)

    PA->>FS: 프로젝트 파일 수집<br/>(README, package.json, PRD, WBS, CLAUDE.md)
    FS-->>PA: 파일 내용

    PA->>PA: 각 파일 파싱<br/>parseReadme(), parsePackageJson(),<br/>parsePrd(), parseWbs(), parseClaudeMd()

    PA->>PA: 프로젝트 타입 감지<br/>detectProjectType()

    PA->>PA: 요구사항/마일스톤 추출<br/>extractRequirementsWithPrd()<br/>extractMilestonesFromWbs()

    PA-->>S: AnalyzedProjectInfo + confidence
    S-->>C: { success, projectInfo }

    C->>C: 분석 결과 화면 표시
    U->>C: 정보 검토 및 수정

    U->>C: "프로젝트로 저장" 클릭
    C->>S: POST /api/projects
    S-->>C: 생성된 Project
    C->>U: 프로젝트 목록으로 이동
```

---

## 3. 프로젝트 분석기 내부 로직

```mermaid
flowchart TD
    A[Start: analyzeProjectFolder] --> B[폴더 경로 검증]
    B --> C{유효한 디렉토리?}
    C -->|No| D[에러 반환]
    C -->|Yes| E[collectProjectFiles]

    E --> F["분석 대상 파일 탐색<br/>README.md, package.json,<br/>pom.xml, build.gradle,<br/>PRD.md, CLAUDE.md, WBS.md"]

    F --> G[getDirectoryStructure<br/>depth=2로 구조 파악]

    G --> H{파일 발견?}
    H -->|No| I[에러: 분석 가능 파일 없음]
    H -->|Yes| J[파일별 파싱 시작]

    J --> K["parsePackageJson()<br/>name, description, version,<br/>author, contributors, dependencies"]

    J --> L["parseReadme()<br/>title, description, features"]

    J --> M["parsePrd()<br/>objectives, features,<br/>requirements, userStories, scope"]

    J --> N["parseClaudeMd()<br/>projectOverview, architecture,<br/>techStack, conventions"]

    J --> O["parseWbs()<br/>phases, milestones, deliverables"]

    J --> P["parsePomXml() / parseBuildGradle()<br/>Java 프로젝트 메타데이터"]

    K & L & M & N & O & P --> Q[detectProjectType]
    Q --> R["프로젝트 타입 결정<br/>React, Vue, Express, Java 등"]

    R --> S[프로젝트 정보 통합]
    S --> T["이름: PRD > package.json > README > 폴더명<br/>설명: PRD > CLAUDE.md > README<br/>범위: PRD scope + 기술스택"]

    T --> U[extractRequirementsWithPrd]
    U --> V["기능 요구사항 추출<br/>PRD features → requirements"]

    V --> W[extractMilestonesFromWbs]
    W --> X["마일스톤 추출<br/>WBS phases → milestones"]

    X --> Y[extractTeam]
    Y --> Z["팀 정보 추출<br/>package.json author/contributors"]

    Z --> AA["신뢰도 계산<br/>files >= 3 → 0.8<br/>files >= 2 → 0.6<br/>files < 2 → 0.4"]

    AA --> AB[AnalyzedProjectInfo 반환]

    style A fill:#e1f5fe
    style AB fill:#c8e6c9
    style D fill:#ffcdd2
    style I fill:#ffcdd2
```

---

## 4. 문서 생성 상세 프로세스

```mermaid
sequenceDiagram
    autonumber
    participant U as 사용자
    participant C as Client (React)
    participant S as Server (Express)
    participant DS as DataStore
    participant G as Generator
    participant FS as 파일 시스템

    U->>C: 프로젝트 및 템플릿 선택
    U->>C: 출력 형식 선택 (DOCX/PPTX/PDF)
    U->>C: "문서 생성" 버튼 클릭

    alt 다운로드 모드
        C->>S: POST /api/documents/generate<br/>{projectId, templateId, format}
    else 폴더 저장 모드
        C->>S: POST /api/documents/generate-and-save<br/>{projectId, templateId, savePath, format}
    end

    S->>DS: getProjectById(projectId)
    DS-->>S: Project 데이터

    S->>DS: getTemplateById(templateId)
    DS-->>S: Template 메타데이터

    S->>FS: fs.readFile(template.filePath)
    FS-->>S: 템플릿 파일 Buffer

    alt format == 'docx'
        S->>G: generateDocx(project, template)
    else format == 'pptx'
        S->>G: generatePptx(project, template)
    else format == 'pdf'
        S->>G: generatePdf(project, template)
    end

    G->>G: JSZip으로 압축 해제
    G->>G: preprocessXml(): 분할된 플레이스홀더 병합
    G->>G: replacePlaceholders(): 데이터 치환
    G->>G: zip.generateAsync(): 새 파일 생성

    G-->>S: Buffer (생성된 문서)

    alt 다운로드 모드
        S-->>C: Binary 응답 (Blob)
        C->>C: URL.createObjectURL(blob)
        C->>U: 파일 다운로드 트리거
    else 폴더 저장 모드
        S->>FS: fs.writeFile(savePath/filename)
        FS-->>S: 저장 완료
        S-->>C: { success, filePath, filename }
        C->>U: 저장 완료 알림
    end
```

---

## 5. DOCX 생성 내부 프로세스

```mermaid
flowchart TD
    A[Start: generateDocx 호출] --> B[fs.readFile로 템플릿 읽기]
    B --> C[JSZip.loadAsync로 압축 해제]
    C --> D[word/document.xml 추출]

    D --> E{document.xml 존재?}
    E -->|Yes| F[preprocessXml: 분할 플레이스홀더 병합]
    E -->|No| G[에러 처리]

    F --> H["replacePlaceholders: {{key}} → value"]
    H --> I[zip.file로 수정된 XML 저장]

    I --> J[header*.xml 파일 처리]
    J --> K[footer*.xml 파일 처리]

    K --> L[zip.generateAsync로 Buffer 생성]
    L --> M[End: Buffer 반환]

    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style G fill:#ffcdd2
```

---

## 6. PPTX 생성 내부 프로세스

```mermaid
flowchart TD
    A[Start: generatePptx 호출] --> B[fs.readFile로 템플릿 읽기]
    B --> C[JSZip.loadAsync로 압축 해제]

    C --> D["slide*.xml 파일 목록 추출<br/>(ppt/slides/slide1.xml, ...)"]

    D --> E{각 슬라이드 반복}
    E -->|다음 슬라이드| F[슬라이드 XML 읽기]
    F --> G["preprocessXml: <a:t> 태그 병합"]
    G --> H["replacePlaceholders: {{key}} → value"]
    H --> I[수정된 XML zip에 저장]
    I --> E

    E -->|완료| J[slideLayout*.xml 처리]
    J --> K[slideMaster*.xml 처리]

    K --> L[zip.generateAsync로 Buffer 생성]
    L --> M[End: Buffer 반환]

    style A fill:#fff3e0
    style M fill:#c8e6c9
```

---

## 7. PDF 생성 내부 프로세스 (신규)

```mermaid
flowchart TD
    A[Start: generatePdf 호출] --> B[PDFKit 문서 생성]
    B --> C[폰트 설정<br/>Helvetica 기본]

    C --> D[문서 헤더 작성]
    D --> E["프로젝트 기본 정보<br/>이름, 고객사, 상태, 기간"]

    E --> F[프로젝트 설명 섹션]
    F --> G[수행 범위 섹션]

    G --> H{팀 구성 있음?}
    H -->|Yes| I[팀 구성 테이블 생성]
    H -->|No| J[건너뛰기]

    I --> K{마일스톤 있음?}
    J --> K
    K -->|Yes| L[마일스톤 목록 생성]
    K -->|No| M[건너뛰기]

    L --> N{요구사항 있음?}
    M --> N
    N -->|Yes| O[요구사항 섹션 생성<br/>기능/비기능]
    N -->|No| P[건너뛰기]

    O --> Q[doc.end()로 문서 완료]
    P --> Q
    Q --> R[Buffer 스트림으로 변환]
    R --> S[End: Buffer 반환]

    style A fill:#fce4ec
    style S fill:#c8e6c9
```

---

## 8. 템플릿 업로드 프로세스

```mermaid
sequenceDiagram
    autonumber
    participant U as 사용자
    participant C as Client
    participant S as Server
    participant M as Multer
    participant P as TemplateParser
    participant DS as DataStore

    U->>C: 파일 선택 + 문서 유형 입력
    U->>C: "업로드" 버튼 클릭

    C->>S: POST /api/templates/upload<br/>(multipart/form-data)

    S->>M: 파일 검증 및 저장

    alt 유효한 파일 (.docx 또는 .pptx)
        M->>M: templates/uploads/에 저장<br/>(UUID 파일명 생성)
        M-->>S: 파일 정보

        S->>P: extractPlaceholders(filePath, format)
        P->>P: JSZip으로 파일 열기
        P->>P: XML에서 {{...}} 패턴 추출
        P-->>S: 플레이스홀더 배열

        S->>DS: createTemplate(template)
        DS->>DS: store.json에 저장
        DS-->>S: 생성된 Template

        S-->>C: 201 Created + Template 데이터
        C-->>U: 템플릿 목록 갱신
    else 유효하지 않은 파일
        M-->>S: 에러
        S-->>C: 400 Bad Request
        C-->>U: 에러 메시지 표시
    end
```

---

## 9. 플레이스홀더 치환 상세

```mermaid
flowchart LR
    subgraph Input["입력 (XML 원본)"]
        A["&lt;w:r&gt;<br/>&lt;w:t&gt;{&#123;&lt;/w:t&gt;<br/>&lt;/w:r&gt;<br/>&lt;w:r&gt;<br/>&lt;w:t&gt;프로젝트&lt;/w:t&gt;<br/>&lt;/w:r&gt;<br/>&lt;w:r&gt;<br/>&lt;w:t&gt;명}&#125;&lt;/w:t&gt;<br/>&lt;/w:r&gt;"]
    end

    subgraph Process["preprocessXml 처리"]
        B["&lt;w:r&gt; 태그 파싱"]
        C["텍스트 연결:<br/>'&#123;&#123;' + '프로젝트' + '명&#125;&#125;'"]
        D["병합된 &lt;w:t&gt; 생성"]
    end

    subgraph Output["출력 (처리된 XML)"]
        E["&lt;w:r&gt;<br/>&lt;w:t&gt;&#123;&#123;프로젝트명&#125;&#125;&lt;/w:t&gt;<br/>&lt;/w:r&gt;"]
    end

    subgraph Replace["replacePlaceholders"]
        F["정규식: /\\{\\{([^}]+)\\}\\}/g"]
        G["keyMap 조회"]
        H["값으로 치환"]
    end

    subgraph Final["최종 결과"]
        I["&lt;w:r&gt;<br/>&lt;w:t&gt;동국제강 스마트 팩토리&lt;/w:t&gt;<br/>&lt;/w:r&gt;"]
    end

    A --> B --> C --> D --> E
    E --> F --> G --> H --> I
```

---

## 10. 데이터 저장 구조

```mermaid
erDiagram
    STORE ||--o{ PROJECT : contains
    STORE ||--o{ TEMPLATE : contains
    STORE ||--o| SETTINGS : has

    PROJECT {
        string id PK
        string name
        string client
        string description
        string scope
        string startDate
        string endDate
        string status
        array team
        array milestones
        object requirements
        string createdAt
        string updatedAt
    }

    TEMPLATE {
        string id PK
        string name
        string documentType
        string format
        string filePath
        array placeholders
        string createdAt
    }

    SETTINGS {
        string claudeApiKey
    }

    PROJECT ||--o{ TEAM_MEMBER : has
    PROJECT ||--o{ MILESTONE : has
    PROJECT ||--o{ REQUIREMENT : has

    TEAM_MEMBER {
        string name
        string role
        string responsibility
    }

    MILESTONE {
        string name
        string date
        string deliverables
    }

    REQUIREMENT {
        string id
        string category
        string description
        string priority
    }

    ANALYZED_PROJECT_INFO {
        string name
        string client
        string description
        string scope
        array team
        array milestones
        object requirements
        array analyzedFiles
        float confidence
    }
```

---

## 11. API 엔드포인트 목록

```mermaid
flowchart LR
    subgraph Projects["프로젝트 API"]
        P1["GET /api/projects"]
        P2["GET /api/projects/:id"]
        P3["POST /api/projects"]
        P4["PUT /api/projects/:id"]
        P5["DELETE /api/projects/:id"]
    end

    subgraph Templates["템플릿 API"]
        T1["GET /api/templates"]
        T2["POST /api/templates/upload"]
        T3["DELETE /api/templates/:id"]
    end

    subgraph Documents["문서 API"]
        D1["POST /api/documents/generate"]
        D2["POST /api/documents/generate-pdf"]
        D3["POST /api/documents/generate-and-save"]
    end

    subgraph Analyze["분석 API"]
        A1["GET /api/analyze/drives"]
        A2["GET /api/analyze/browse"]
        A3["POST /api/analyze/folder"]
    end

    subgraph System["시스템 API"]
        S1["GET /api/health"]
    end
```

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /api/projects | 모든 프로젝트 조회 |
| GET | /api/projects/:id | 프로젝트 상세 조회 |
| POST | /api/projects | 프로젝트 생성 |
| PUT | /api/projects/:id | 프로젝트 수정 |
| DELETE | /api/projects/:id | 프로젝트 삭제 |
| GET | /api/templates | 모든 템플릿 조회 |
| POST | /api/templates/upload | 템플릿 업로드 (multipart) |
| DELETE | /api/templates/:id | 템플릿 삭제 |
| POST | /api/documents/generate | 문서 생성 (다운로드) |
| POST | /api/documents/generate-pdf | PDF 생성 |
| POST | /api/documents/generate-and-save | 문서 생성 후 저장 |
| GET | /api/analyze/drives | 드라이브 목록 조회 |
| GET | /api/analyze/browse | 디렉토리 탐색 |
| POST | /api/analyze/folder | 프로젝트 폴더 분석 |
| GET | /api/health | 서버 상태 확인 |

---

## 12. 에러 핸들링 흐름

```mermaid
flowchart TD
    subgraph DocumentGeneration["문서 생성"]
        A[문서 생성 요청] --> B{프로젝트 존재?}
        B -->|No| C[404: Project not found]
        B -->|Yes| D{템플릿 존재?}
        D -->|No| E[404: Template not found]
        D -->|Yes| F{템플릿 파일 존재?}
        F -->|No| G[500: File read error]
        F -->|Yes| H[문서 생성 시작]
        H --> I{생성 성공?}
        I -->|No| J[500: Generation failed]
        I -->|Yes| K[200: Buffer 응답]
    end

    subgraph FolderAnalysis["폴더 분석"]
        L[폴더 분석 요청] --> M{경로 제공?}
        M -->|No| N[400: 경로 필요]
        M -->|Yes| O{유효한 디렉토리?}
        O -->|No| P[Error: 유효하지 않은 경로]
        O -->|Yes| Q{분석 가능 파일?}
        Q -->|No| R[Error: 분석 파일 없음]
        Q -->|Yes| S[분석 수행]
        S --> T{분석 성공?}
        T -->|No| U[500: Analysis failed]
        T -->|Yes| V[200: projectInfo 반환]
    end

    style C fill:#ffcdd2
    style E fill:#ffcdd2
    style G fill:#ffcdd2
    style J fill:#ffcdd2
    style N fill:#ffcdd2
    style P fill:#ffcdd2
    style R fill:#ffcdd2
    style U fill:#ffcdd2
    style K fill:#c8e6c9
    style V fill:#c8e6c9
```

---

## 13. 클라이언트 라우팅 구조

```mermaid
flowchart TD
    A[App Entry] --> B{인증 상태?}
    B -->|미인증| C["/login → LoginPage"]
    B -->|인증됨| D[ProtectedRoute + Layout]

    D --> E["/ → HomePage"]
    D --> F["/projects → ProjectsPage"]
    D --> G["/projects/new → ProjectFormPage"]
    D --> H["/projects/:id → ProjectFormPage (수정)"]
    D --> I["/projects/analyze → AnalyzePage"]
    D --> J["/templates → TemplatesPage"]
    D --> K["/generate/:projectId → GeneratePage"]

    C --> L{로그인 성공?}
    L -->|Yes| D
    L -->|No| C
```

---

## 14. 사용자 여정 맵

```mermaid
journey
    title DocuGen 사용자 여정
    section 초기 설정
      로그인: 5: 사용자
      홈 화면 확인: 5: 사용자
    section 프로젝트 등록 (수동)
      프로젝트 목록 이동: 4: 사용자
      새 프로젝트 클릭: 4: 사용자
      기본 정보 입력: 3: 사용자
      팀원/마일스톤 추가: 3: 사용자
      저장: 5: 사용자
    section 프로젝트 등록 (자동 분석)
      프로젝트 분석 이동: 5: 사용자
      폴더 탐색: 4: 사용자
      분석 시작: 5: 사용자
      결과 확인/수정: 4: 사용자
      프로젝트로 저장: 5: 사용자
    section 템플릿 관리
      템플릿 파일 준비: 3: 사용자
      플레이스홀더 삽입: 2: 사용자
      템플릿 업로드: 4: 사용자
    section 문서 생성
      프로젝트 선택: 5: 사용자
      템플릿 선택: 5: 사용자
      출력 형식 선택: 5: 사용자
      문서 생성 클릭: 5: 사용자
      다운로드/저장: 5: 사용자
    section 결과 확인
      문서 열기: 4: 사용자
      내용 확인: 4: 사용자
```

---

## 15. 분석 파일 우선순위

```mermaid
flowchart TD
    subgraph Priority["정보 추출 우선순위"]
        direction LR

        subgraph Name["프로젝트명"]
            N1["1. PRD.md title"]
            N2["2. package.json name"]
            N3["3. pom.xml artifactId"]
            N4["4. README.md title"]
            N5["5. 폴더명"]
            N1 --> N2 --> N3 --> N4 --> N5
        end

        subgraph Desc["설명"]
            D1["1. PRD overview"]
            D2["2. CLAUDE.md overview"]
            D3["3. README description"]
            D4["4. package.json description"]
            D1 --> D2 --> D3 --> D4
        end

        subgraph Req["요구사항"]
            R1["1. PRD features"]
            R2["2. PRD requirements"]
            R3["3. PRD userStories"]
            R4["4. README features"]
            R1 --> R2 --> R3 --> R4
        end

        subgraph Mile["마일스톤"]
            M1["1. WBS milestones"]
            M2["2. WBS phases"]
            M3["3. WBS deliverables"]
            M1 --> M2 --> M3
        end
    end
```

---

## 16. 지원 프로젝트 타입

```mermaid
mindmap
  root((프로젝트 타입<br/>자동 감지))
    JavaScript/TypeScript
      React
      Vue.js
      Angular
      Svelte
      Next.js
      Nuxt.js
      Node.js
      Express.js
      Fastify
      NestJS
    Java
      Maven
      Gradle
    Python
      Django
      Flask
      FastAPI
    Go
    Rust
```

---

*다이어그램 도구: Mermaid.js*
*최종 업데이트: 2024.12.21*
*버전: 2.0 - 프로젝트 분석 기능 추가*
